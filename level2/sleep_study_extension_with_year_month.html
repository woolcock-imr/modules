<section>
    <div id=toolbar__ID>
          <a id=back__ID>Back</a> <a id=new__ID>New</a> <a id=save__ID>Save</a>
          <span class=tab__ID></span>
          <input placeholder='name' id=keyword__ID type=text style='display:none' />
		  <select id=age__ID><option>Adult</option><option>Child</option></select>
          Year: <select id=yy__ID type=text />
          Month: <select id=mm__ID type=text />
          <a id=query__ID>Load</a>
          <span id=multi__ID>
              <span class=tab__ID></span>Page Size: <select id=page_size__ID><option>30</option><option>50</option><option>100</option><option>200</option></select><span class=tab__ID></span>
              <span id=I__ID style="display:none">0</span><span id=A__ID></span>
              <img id=p__ID src="__BASE__/vmiis/Common-Code/image/p.png" ><img id=n__ID src="__BASE__/vmiis/Common-Code/image/n.png" >
          </span>
          <span id=elapsed__ID style='float:right'></span>
    </div>
	<div id=table__ID>
        <table id=grid__ID></table>
    </div>
</section>
<script>
function F__ID(){
	//-------------------------------------
	VmInclude:__LIB__/vmiis/Common-Code/grid/grid2.js
	VmInclude:__LIB__/vmiis/Common-Code/style/ease-in-out_2.js
	//-------------------------------------
	//year dropdown
	var $List1=$('#yy__ID');
	var y=new Date().getFullYear();
	for(var i=0;i<10;i++){
		$List1.append(  $('<option></option>').val(y-i).html(y-i)  );
	}
	$List1.val(y);
	//-------------------------------------
	//month dropdown
	var $List2=$('#mm__ID');
	var m=new Date().getMonth()+1;
	for(var i=0;i<12;i++){
		$List2.append(  $('<option></option>').val(i+1).html(i+1)  );
	}
	$List2.val(m);
	//---------------------------------------------
	$('#new__ID').hide();
	//-------------------------------------
	var fields="Date of Study|I2_Date,Name & D.O.B|I2_Patient,Type|I2_Study_Type,Item #|I2_Code,Cost,Reporting Dr|I2_Reporting_Physician,Reported|I2_Reported_text,Outcome,Submitted_on,Report_Comments";
	fields+=",Colour_1,Colour_2,Colour_3";
	_fields="_Form,"+fields;
	//-------------------------------------
	$('#D__ID').on('load',function(){  _set_req(); _request_data(); })
	//-------------------------------------
	_set_req=function(){
		var y=$('#yy__ID').val(), m=$('#mm__ID').val();
		var t1=new Date(y,m-1,1,0,0,0,0);
		var t2=new Date(y,m,  1,0,0,0,0);

		var code=" and (@('Code')=12203 or @('Code')=12210 or @('Code')=12217 or @('Code')=12213 or @('Code')=11003 or @('Code')=12250)";
		var age0=" and case when isdate(LTRIM(SUBSTRING(S2,CHARINDEX(',',S2)+1,LEN(S2)-CHARINDEX(',',S2))))=1  then datediff(day,cast(LTRIM(SUBSTRING(S2,CHARINDEX(',',S2)+1,LEN(S2)-CHARINDEX(',',S2))) as DateTime),DT1)/365 else 20 end";
		var age=age0+">17";
		if( $('#age__ID').val()=='Child') age=age0+"<=17";
		var other=" and @('Study_Type')<>'Self funded PSG' and @('Report_Not_Required')<>'on' and @('Cancelled')<>'on' and @('Arrival_Status')<>'Did Not Arrive' ";

		var sql="SET DATEFORMAT dmy; with tb1 as (select ID,Information,PUID,DateTime,Author from [TABLE-20010715-@S1] )";
		sql+=",tb2 as (select DT1,Information2=Information,UID,RowNum=row_number() over (order by DT1 DESC,UID DESC) from [TABLE-400448-@S1] where DT1>=@T1 and DT1<@T2"+code+age+other+")";
		sql+="select ID,UID,PUID,Information2,Information,RowNum,DateTime,Author from tb2 left join tb1 on PUID=UID where RowNum between @I6 and @I7";
		var sql_n="select count(ID) from [TABLE-400448-@S1] where DT1>=@T1 and DT1<@T2"+code+age+other;
		_req={cmd:'query_records',db_pid:_db_pid,sql:sql,sql_n:sql_n,s1:'"'+$('#keyword__ID').val()+'"',s2:$('#age__ID').val(),t1:t1,t2:t2,I:$('#I__ID').text(),page_size:$('#page_size__ID').val()}
	}
	//-------------------------------------
	_cell_render=function(records,I,field,td,set_value,source){
		switch(field){
			case 'I2_Date':
			case 'I2_Patient':
			case 'I2_Study_Type':
			case 'I2_Code':
			case 'I2_Reporting_Physician':
			case 'I2_Reported_text':
				records[I].vm_readonly[field]=true;
				break;
			case 'Colour_1':
			case 'Colour_2':
			case 'Colour_3':
				if(records[I][field]==undefined) records[I][field]='#eeeeee';
				VmInclude:__BASE__/vmiis/Common-Code/grid/field_color.js
				break;
			case 'Cost':
				td.on('click',function(){
					if($(this).text()==''){
						var a=records[I].I2_Code;
						$VmAPI.request({data:{cmd:'query_records',sql:'select V2 from [TABLE-20010718] where V1=@d1',d1:a},callback:function(res){
							if(res.records.length==1){
								//records[I].Cost=res.records[0].V2;
								_set_value(res.records[0].V2,_records,I,field);
								td.text(parseFloat(res.records[0].V2).toFixed(2))
							}
						}});
					}
				})
				break;
			case 'Outcome':
				var html="<select style='border:0;width:100%'>\
					<option value='' >...</option>\
					<option >Submitted</option>\
					<option >Paid</option>\
					</select>\
				";
				VmInclude:__BASE__/vmiis/Common-Code/grid/field_select.js
				break;
			case 'Submitted_on':
				VmInclude:__BASE__/vmiis/Common-Code/grid/field_date.js
				break;
		}
	}
	//-------------------------------------
	_before_submit=function(record,dbv){
		dbv.PUID=record.UID;
		return true;
	};
	//-------------------------------------
}
</script>
<style>
    VmInclude:__LIB__/vmiis/Common-Code/grid/grid.css
    VmInclude:__LIB__/vmiis/Common-Code/style/ease-in-out_2.css
</style>
